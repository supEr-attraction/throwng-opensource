# 포팅 매뉴얼

## 기술 스택

1. Issue Management
    - JIRA
2. SCM
    - GitLab
3. Communities
    - Notion
    - MatterMost
    - Gather
4. Development Environment
    - React
    - Node.js
    - TypeScript
    - Flutter
    - Kotlin
    - SpringBoot: ^2.7.18
    - SpringCloud:^2021.0.9
    - Docker:  ^4.26.1
    - JVM: Zulu "11.0.21" 2023-10-17 LTS
    - VS Code: 1.85.1
    - IntelliJ: 17.0.9+7-b1087.9 amd64
    - Android 스튜디오 Jellyfish | 2023.3.1
    - DB: Mysql 8.0.28
    - Redis
    - mongoDB
    - Nginx
    - Prometheus
    - Grafana
    - S3
    - Cypress
    - Jenkins
    - Pinpoint
5. ETC
    - 디자인: Figma
    - UCC: DaVinci Resolve
    - PPT: PowerPoint & Google Slides

<br>

## Jenkins Setting
- Jenkins에 sudo 권한 주기
```bash
sudo visudo
jenkins ALL=(ALL) NOPASSWD: ALL
```
- Jenkins에 docker 실행 권한 주기
```bash
sudo usermod -aG docker jenkins
sudo service jenkins restart
```
- Jenkins 포트 번호 7080 으로 변경 
```bash
sudo vim /etc/default/jenkins // HTTP_PORT 7080 으로 변경
sudo chmod 777 /usr/lib/systemd/system/jenkins.service
sudo vim /usr/lib/systemd/system/jenkins.service // Environment="JENKINS_PORT=7080" 으로 변경
sudo chmod 444 /usr/lib/systemd/system/jenkins.service
sudo systemctl daemon-reload
sudo service jenkins restart
```
<br>

## Prod Deployment Jenkins Pipeline

1. Music Back End Server
    
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/music") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/music") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
                dir("./back/music") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}    
```

2. Notification Back End Server
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/notification") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/notification") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
                dir("./back/notification") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
}
```

3. Quiz Back End Server
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/quiz") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/quiz") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
               
                // script {
                //     sshagent(credentials: ['throwngSSH']) {
                //         'scp -o StrictHostKeyChecking=no -P 5112 build/libs/batch-0.0.1-SNAPSHOT.jar ubuntu@13.125.0.190:/home/ubuntu/docker/'
                //         'ssh -p 5112 ubuntu@13.125.0.190 /home/ubuntu/docker/deploy.sh'
                //     }
                // }
                dir("./back/quiz") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

4. User Back End Server
```bash
pipeline {
    environment { 
        //repository = "alswjd00"  //docker hub id와 repository 이름
        DOCKERHUB_CREDENTIALS = credentials('dockerHub') // jenkins에 등록해 놓은 docker hub credentials 이름
        repository = "alswjd00/throng-dev-music"
        JAR_FILE_PATH = '/var/lib/jenkins/workspace/test_blue_green_batch/back/batch/build/libs'
        dockerImage = '' 
        DEPLOY_PATH = '/home/ubuntu'
    }
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
        
        stage('Read Build Info') {
            steps {
                dir("./back/user") {
                    script {
                        def versionFile = readFile 'build.gradle'
                        def versionMatch = versionFile =~ /version\s+=\s+['"](.+)['"]/
                        echo "${versionMatch}"
                        VERSION = versionMatch ? versionMatch[0][1] : 'Unknown'
                        echo "Build Version: ${VERSION}"
                    }
                }
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/user") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"     
                }
            }
        }
        
        stage('Run script') {
            steps {
                dir("./back/user") {
                    sh "ls"
                    sh "sh ./deploy-prod.sh"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}

```

5. Batch Back Server
``` bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/batch") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-batch:${env.BUILD_NUMBER} back/batch/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-batch || true && docker rm back-batch || true"
                    sh "docker run -p 8083:8083 --name back-batch -d --network connect-default -e TZ=Asia/Seoul back-batch:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}

```

6. Config Back Server
```bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/config") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-config:${env.BUILD_NUMBER} back/config/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-config || true && docker rm back-config || true"
                    sh "docker run -p 8088:8088 --name back-config -d --network connect-default -e TZ=Asia/Seoul back-config:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }

    }
}
```

7. Discovery Back Server
```bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/discovery") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-discovery:${env.BUILD_NUMBER} back/discovery/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-discovery || true && docker rm back-discovery || true"
                    sh "docker run -p 8761:8761 --name back-discovery -d --network connect-default -e TZ=Asia/Seoul back-discovery:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

8. Gateway Back Server
```bash
pipeline {
    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'master', credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git'
            }
        }
    
        stage('BE_Build') {
            steps {
                dir("./back/gateway") {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"      // 빌드
                }
            }
        }
        
        stage('Build Docker'){
            steps{
                script{
                    sh "docker build -t back-gateway:${env.BUILD_NUMBER} back/gateway/"
                }
            }
        }
        
        stage('Deploy Docker'){
            steps{
                script{
                    sh "docker stop back-gateway || true && docker rm back-gateway || true"
                    sh "docker run -p 8081:8081 --name back-gateway -d --network connect-default -e TZ=Asia/Seoul back-gateway:${env.BUILD_NUMBER}"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```
    
9. Front End Server
    
```bash
pipeline {

    agent any
    
    stages {
        stage('Git Clone') {
            steps {
                checkout scmGit(
                    branches: [[name: 'master']],
                    extensions: [submodule(parentCredentials: true, reference: '', trackingSubmodules: true)],
                    userRemoteConfigs: [[credentialsId: 'gitlab_mj', url: 'https://lab.ssafy.com/s10-final/S10P31C101.git']]
                )
            }
        }
        
        stage('Run script') {
            steps {
                dir("./front") {
                    sh "ls"
                    sh "whoami"
                    sh "chmod +x ./deploy-prod.sh"
                    sh "sh ./deploy-prod.sh"
                    //sh "sed -i 's/5173/5174/' /etc/nginx/conf.d/include/service_uri.conf"
                    sh "docker image prune -a -f || true"
                }
            }
        }
    }
    
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)"
                )
            }
        }
    }
}
```

<br>

## MySQL WorkBench Connection

1. Spring Boot에서 연결
    1. application.properties
    
    ```jsx
    spring.datasource.url=jdbc:mysql://sieum.co.kr:3307/throwng?serverTimezone=UTC&characterEncoding=UTF-8
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    spring.datasource.username="mysql 계정 아이디"
    spring.datasource.password="mysql 계정 비밀번호"
    ```
    
    b. “스키마 이름”과 동일한 이름의 스키마를 생성
    
2. Standard TCP/IP 연결
    1. MySql Workbench에서 NewConnection
    - Connection Name: {관리용 이름}
    - Connection Method: Standard (TCP/IP)
    - HostName: {Public DNS 또는 Public IP}
    - Port: {Mysql이 설치된 포트}
    - UserName: {사용자 입력}
    - Password: Store in Vault … 을 클릭 후 입력
    - Test Connection을 누르고 에러 메세지가 뜨지 않으면 OK를 누른다.

<br>

## /etc/nginx/sites-available/default
```bash
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
#server {
#       listen 80 default_server;
#       listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

#       root /var/www/html;

        # Add index.php to the list if you are using PHP
#       index index.html index.htm index.nginx-debian.html;

#       server_name sieum.co.kr;

#       location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                #try_files $uri $uri/ =404;i
#               root /var/www/html;
#               index index.html index.htm index.nginx-debian.html;
#       }

        # pass PHP scripts to FastCGI server
        #
        #location ~ \.php$ {
        #       include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
        #       fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
#}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}


limit_req_zone $binary_remote_addr zone=ddos_req:10m rate=5r/s;
limit_conn_zone $binary_remote_addr zone=ddos_conn:10m;
limit_req_status 429;
client_max_body_size 10M;

server {
        listen 443;

        ssl on;
        ssl_certificate /etc/ssl/certificate.crt;
        ssl_certificate_key /etc/ssl/private.key;

        server_name sieum.co.kr;
        client_body_timeout 10s;
        client_header_timeout 10s;
        autoindex_localtime on;

        access_log /var/log/nginx/nginx.vhost.access.log;
        error_log /var/log/nginx/nginx.vhost.error.log;

        location / {
                #proxy_pass http://localhost:9003;
                include /etc/nginx/conf.d/include/service_uri.conf;
                proxy_http_version 1.1;
                proxy_set_header Connection '';
        }

        location /api/ {
                proxy_pass http://localhost:8081/;
                limit_req zone=ddos_req burst=5;
                limit_conn ddos_conn 10;
        }

        location /jenkins/ {
 #               root /var/www/html;
  #              index index.html index.htm index.nginx-debian.html;
                proxy_pass http://localhost:8080/;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X_Forearded-Proto $scheme;
        }

        location /grafana-server {
                proxy_pass http://localhost:3000;
        }

#       location /jenkins {
#               proxy_pass http://localhost:8080;
#       }

}

server{
        if ($host = www.sieum.co.kr){
                return 301 https://$host$request_uri;
        }

        listen 80;
        listen [::]:80;
        server_name sieum.co.kr;
        return 404;
}

```

<br>

## /etc/nginx/conf.d/include/service_uri.conf
```bash
proxy_pass http://localhost:5173;
```

<br>

## Monitoring 설정 
### 1. Prometheus 
```bash
wget https://github.com/prometheus/prometheus/releases/download/v2.52.0/prometheus-2.52.0.linux-amd64.tar.gz

tar -zxvf prometheus-2.52.0.linux-amd64.tar.gz

vi prometheus.yml
```

### 2. Grafana 
```bash
sudo apt-get install -y adduser libfontconfig1 musl

wget https://dl.grafana.com/enterprise/release/grafana-enterprise_11.0.0_amd64.deb

sudo dpkg -i grafana-enterprise_11.0.0_amd64.deb

sudo service grafana-server start 

sudo service grafana-server status
```


### 3. Pinpoint
1. HBase 설치 
```bash
sudo apt-get install openjdk-8-jdk

wget https://archive.apache.org/dist/hbase/1.2.7/hbase-1.2.7-bin.tar.gz
tar -zxvf hbase-1.2.7-bin.tar.gz

vi hbase-1.2.7/conf/hbase-env.sh

# export HBASE_MASTER_OPTS="$HBASE_MASTER_OPTS -XX:PermSize=128m -XX:MaxPermSize=128m"
# export HBASE_REGIONSERVER_OPTS="$HBASE_REGIONSERVER_OPTS -XX:PermSize=128m -XX:MaxPermSize=128m"
export JAVA_HOME=jdk의 경로 (/usr/lib/jvm/java-1.8.0-openjdk-amd64) 

ln -s hbase-1.2.7 hbase

hbase/bin/start-hbase.sh 

wget https://raw.githubusercontent.com/pinpoint-apm/pinpoint/master/hbase/scripts/hbase-create.hbase

hbase-1.2.7/bin/hbase shell ~/hbase-create.hbase
```

2. Pinpoint Agent 설치
```bash

wget https://github.com/pinpoint-apm/pinpoint/releases/download/v2.2.2/pinpoint-agent-2.2.2.tar.gz

tar xvzf pinpoint-agent-2.2.2.tar.gz

cd pinpoint-agent-2.2.2

sudo vi pinpoint-root.config

profiler.transport.grpc.collector.ip=pinpoint서버 ip

profiler.transport.grpc.collector.ip=[pinpoint서버 ip]
profiler.collector.ip=[pinpoint서버 ip]

$ vi /usr/local/pinpoint-agent-2.3.3/profiles/local/pinpoint.config
profiler.transport.grpc.collector.ip=[pinpoint서버 ip]
profiler.collector.ip=[pinpoint서버 ip]

$ vi /usr/local/pinpoint-agent-2.3.3/profiles/release/pinpoint.config
profiler.transport.grpc.collector.ip=[pinpoint서버 ip]
profiler.collector.ip=[pinpoint서버 ip]
```

3. Pinpoint Collector 설치
```bash
wget https://github.com/pinpoint-apm/pinpoint/releases/download/v2.2.2/pinpoint-collector-boot-2.2.2.jar

chmod +x pinpoint-collector-boot-2.2.2.jar

nohup java -jar -Dpinpoint.zookeeper.address=localhost pinpoint-collector-boot-2.2.2.jar >/dev/null 2>&1 &

nohup java -Dpinpoint.zookeeper.address=localhost -Dserver.port=9081 -jar pinpoint-collector-boot-2.2.2.jar >/dev/null 2>&1 &

java -Dpinpoint.zookeeper.address=localhost -Dserver.port=9081 -jar pinpoint-collector-boot-2.2.2.jar
```

4. Pinpoint web 설치 
```bash
wget https://github.com/pinpoint-apm/pinpoint/releases/download/v2.2.2/pinpoint-web-boot-2.2.2.jar

chmod +x pinpoint-web-boot-2.2.2.jar

nohup java -Dpinpoint.zookeeper.address=localhost -jar pinpoint-web-boot-2.2.2.jar >/dev/null 2>&1 &
```

5. 9991 ~ 9997 포트 개방 

## Spring yml 설정
**gateway.yml**
```
spring:
  cloud:
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins:
              - "http://localhost:5174"
              - "http://localhost:5173"
              - "http://localhost:4173"
              - "https://wjdxodbs.github.io"
              - "https://k10c101.p.ssafy.io"
              - "https://throwng-dev.store"
              - "https://www.sieum.co.kr"
            allow-credentials: true
            allowedHeaders:
              - x-requested-with
              - authorization
              - accessToken
              - content-type
              - credential
              - X-AUTH-TOKEN
              - X-CSRF-TOKEN
            allowedMethods:
              - POST
              - GET
              - PUT
              - PATCH
              - OPTIONS
              - DELETE

      routes:
        - id: user
          predicates:
            - Path=/users/user/**
          uri: lb://USER
          sensitive-headers: Cookie,Set-Cookie
          #filters:
          #  - CustomAuthFilter
        - id: user
          predicates:
            - Path=/users/auth/**
          uri: lb://USER
          sensitive-headers: Cookie,Set-Cookie
        - id: user
          predicates:
            - Path=/users/watch/**
          uri: lb://USER
          sensitive-headers: Cookie,Set-Cookie
        - id: user
          predicates:
            - Path=/users/connect
          uri: lb://USER
        - id: quiz
          predicates:
            - Path=/quizzes/**
          uri: lb://QUIZ
          sensitive-headers: Cookie,Set-Cookie
          #filters:
           # - CustomAuthFilter
        - id: music
          predicates:
            - Path=/music/**
          uri: lb://MUSIC
          sensitive-headers: Cookie,Set-Cookie
          #filters:
           # - CustomAuthFilter
        - id: notification
          predicates:
            - Path=/notifications/**
          uri: lb://NOTIFICATION
          sensitive-headers: Cookie,Set-Cookie
          #filters:
           # - CustomAuthFilter

management:
  endpoints:
    web:
      exposure:
        include: "*"
          #- "gateway"
  endpoint:
    gateway:
      enabled: true

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    service-url:
      default-zone: {default-zone}
---
spring:
  config:
    activate:
      on-profile: dev

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    service-url:
      default-zone: {default-zone}
---
spring:
  config:
    activate:
      on-profile: prod

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    service-url:
      default-zone: {default-zone}

```

**music.yml**
```
spring:
  # sql:
  #   init:
  #     data-locations: classpath:/sql/*
  #     mode: always
  servlet:
    multipart:
      maxFileSize: 10MB
      maxRequestSize: 10MB
      
  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.spatial.dialect.mysql.MySQL8SpatialDialect
    hibernate:
      ddl-auto: update
      dialect: org.hibernate.dialect.MySQL5InnoDBDialect
   
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: {defaultZone}

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

youtube:
  api-key: {api-key}

cloud:
  aws:
    s3:
      bucket: {bucket}
    credentials:
      access-key: {access-key}
      secret-key: {secret-key}
    region:
      static: ap-northeast-2
      auto: false
    stack:
      auto: false

spotify:
  client-id: {client-id}
  client-secret: {client-secret}

kakao:
  reverse:
    geo:
      url: {url}
  admin-key: {admin-key}

management:
  endpoints:
    web:
      exposure:
        include: "*"

notification:
  mattermost:
    enabled: false
    webhook-url: {webhook-url}
    channel: {channel}
    author-name: {author-name}
    author-icon: {author-icon}


---
spring:
  config:
    activate:
      on-profile: dev

  # eureka:
  #   client:
  #     service-url:
  #       default-zone: {default-zone}

  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  # sql:
  #   init:
  #     data-locations: classpath:/sql/*
  #     mode: always

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.spatial.dialect.mysql.MySQL8SpatialDialect
    hibernate:
      ddl-auto: update
      dialect: org.hibernate.dialect.MySQL5InnoDBDialect

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

youtube:
  api-key: {api-key}

cloud:
  aws:
    credentials:
      accessKey: {accessKey}
      secretKey: {secretKey}
    s3:
      bucket: {bucket}
    region:
      static: ap-northeast-2
    stack:
      auto: 'false'
spotify:
  client-id: {client-id}
  client-secret: {client-secret}

```

**music-prod.yml**
```
server:
  port: 8084
  servlet:
    context-path: /music

spring:
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
      
  application:
    name: music
  
  servlet:
    multipart:
      maxFileSize: 10MB
      maxRequestSize: 10MB

  eureka:
    client:
      service-url:
        default-zone: {default-zone}

  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.spatial.dialect.mysql.MySQL8SpatialDialect
    hibernate:
      ddl-auto: update
      dialect: org.hibernate.dialect.MySQL5InnoDBDialect
   
redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

notification:
  mattermost:
    enabled: true
    webhook-url: {webhook-url}
    channel: {channel}
    author-name: {author-name}
    author-icon: {author-icon}

kakao:
  reverse:
    geo:
      url: {url}
  admin-key: {admin-key}

cloud:
  aws:
    credentials:
      accessKey: {accessKey}
      secretKey: {secretKey}
    s3:
      bucket: {bucket}
    region:
      static: ap-northeast-2
    stack:
      auto: 'false'

```

**notification.yml**
```
eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: {defaultZone}

spring:
  application:
    name: notification
  data:
    mongodb:
      # uri: mongodb+srv://tmddus3rd:niELcBK0u3hzRfzr@throwng.q56unez.mongodb.net/?retryWrites=true&w=majority&appName=Throwng
      uri: {url}
      database: {database}
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

swagger:
  host: {host}

redis:
  host: {host}
  port: {port}

```

**notification-prod.yml**
```
server:
  port: 8082
  servlet:
    context-path: /notifications

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: {defaultZone}

spring:
  config:
    activate:
      on-profile: prod
  application:
    name: notification
  data:
    mongodb:
      uri: {url}
      database: {database}
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

swagger:
  host: {host}

redis:
  host: {host}
  port: {port}


```

**quiz.yml**
```
spring:
  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        # dialect: org.hibernate.dialect.MySQLDialect
    hibernate:
      ddl-auto: update
      # dialect: org.hibernate.dialect.MySQL5InnoDBDialect

  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: {defaultZone}

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

notification:
  mattermost:
    enabled: true
    webhook-url: {webhook-url}
    channel: {channel}
    author-name: {author-name}
    author-icon: {author-icon}

management:
  endpoints:
    web:
      exposure:
        include: "*"

```

**quiz-prod.yml**
```
server:
  port: 8085
  servlet:
    context-path: /quizzes

spring:
  config:
    activate:
      on-profile: prod
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
      
  application:
    name: quiz

  eureka:
    client:
      service-url:
        default-zone: {default-zone}

  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
    hibernate:
      ddl-auto: update
      # dialect: org.hibernate.dialect.MySQL5InnoDBDialect

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

notification:
  mattermost:
    enabled: true
    webhook-url: {webhook-url}
    channel: {channel}
    author-name: {author-name}
    author-icon: {author-icon}

```

**user.yml**
```
spring:
  datasource:
    url: {url}
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQLDialect
    hibernate:
      ddl-auto: update
      dialect: org.hibernate.dialect.MySQL5InnoDBDialect

  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}:${spring.application.instance_id:${random.value}}
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: {defaultZone}

security:
  jwt:
    #access-expiration-time: {access-expiration-time}
    access-expiration-time: {access-expiration-time}
    refresh-expiration-time: {refresh-expiration-time}
    secret-key: {secret-key}

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

oauth2:
  provider:
    kakao:
      client-id: {client-id}
      redirect-uri: {redirect-uri}
      token-uri: {token-uri}
      user-info: {user-info}
      client-secret: {client-secret}
      unlink-uri: {unlink-uri}
      admin-key: {admin-key}

management:
  endpoints:
    web:
      exposure:
        include: "*"

notification:
  mattermost:
    enabled: false
    webhook-url: {webhook-url}
    channel: {channel}
    author-name: {author-name}
    author-icon: {author-icon}

---
spring:
  config:
    activate:
      on-profile: dev

  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

  # eureka:
  #   client:
  #     service-url:
  #       default-zone: {default-zone}

  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
    hibernate:
      ddl-auto: update
      dialect: org.hibernate.dialect.MySQL5InnoDBDialect

security:
  jwt:
    access-expiration-time: {access-expiration-time}
    refresh-expiration-time: {refresh-expiration-time}
    secret-key: {secret-key}

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

oauth2:
  provider:
    kakao:
      client-id: {client-id}
      redirect-uri: {redirect-uri}
      token-uri: {token-uri}
      user-info: {user-info}
      client-secret: {client-secret}
      unlink-uri: {unlink-uri}
      admin-key: {admin-key}

```

**user-prod.yml**
```
server:
  port: 8086
  servlet:
    context-path: /users

spring:
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher
      
  application:
    name: user

  eureka:
    client:
      service-url:
        default-zone: {default-zone}

  datasource:
    url: {url}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: {username}
    password: {password}

  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
    hibernate:
      ddl-auto: update
      dialect: org.hibernate.dialect.MySQL5InnoDBDialect

security:
  jwt:
    access-expiration-time: {access-expiration-time}
    refresh-expiration-time: {refresh-expiration-time}
    secret-key: {secret-key}

redis:
  host: {host}
  port: {port}

swagger:
  host: {host}

oauth2:
  provider:
    kakao:
      client-id: {client-id}
      redirect-uri: {redirect-uri}
      token-uri: {token-uri}
      user-info: {user-info}
      client-secret: {client-secret}
      unlink-uri: {unlink-uri}
      admin-key: {admin-key}

notification:
  mattermost:
    enabled: true
    webhook-url: {webhook-url}
    channel: {channel}
    author-name: {author-name}
    author-icon: {author-icon}

```

<br>

## .env
```
VITE_GOOGLE_MAP_API = {VITE_GOOGLE_MAP_API}
VITE_KAKAO_API = {VITE_KAKAO_API}
VITE_APP_FCM_API_KEY = {VITE_APP_FCM_API_KEY}
VITE_APP_FCM_AUTH_DOMAIN = {VITE_APP_FCM_AUTH_DOMAIN}
VITE_APP_FCM_PROJECT_ID = {VITE_APP_FCM_PROJECT_ID}
VITE_APP_FCM_STORAGE_BUCKET = {VITE_APP_FCM_STORAGE_BUCKET}
VITE_APP_FCM_MESSAGING_SENDER_ID = {VITE_APP_FCM_MESSAGING_SENDER_ID}
VITE_APP_FCM_APP_ID = {VITE_APP_FCM_APP_ID}
VITE_APP_FCM_MEASUREMENT_ID = {VITE_APP_FCM_MEASUREMENT_ID}
VITE_APP_VAPID_KEY = {VITE_APP_VAPID_KEY}
VITE_CYPRESS_JWT_TOKEN = {VITE_CYPRESS_JWT_TOKEN}
VITE_CYPRESS_RECODE_KEY = {VITE_CYPRESS_RECODE_KEY}
SENTRY_AUTH_TOKEN = {SENTRY_AUTH_TOKEN}
VITE_SENTRY_DNS = {VITE_SENTRY_DNS}
```

## .env.dev
```
VITE_BASE_URL = "https://throwng-dev.store"
```

## .env.prod
```
VITE_BASE_URL = "https://www.sieum.co.kr"
```

<br>

## EC2 Setting
**swap 설정**
```
sudo dd if=/dev/zero of=/swapfile bs=128M count=256
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
sudo swapon -s
```

<br>

## .gitignore

```bash
back/HELP.md
.gradle
build/
!gradle/wrapper/gradle-wrapper.jar
!**/src/main/**/build/
!**/src/test/**/build/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache
bin/
!**/src/main/**/bin/
!**/src/test/**/bin/

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr
out/
!**/src/main/**/out/
!**/src/test/**/out/

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/

### VS Code ###
.vscode/

```

<br>

## Settings or Tips

1. 환경 변수 설치
    
    ```bash
    git submodule init
    git submodule update
    git submodule update --remote
    ```
    
2. 외부 서비스 사용
    1. KaKao Oauth
        - https://kauth.kakao.com/oauth/token
        - https://kapi.kakao.com/v2/user/me
        - https://kapi:kakao:com/v1/user/unlink
    2. Kakao Convert coordinates to administrative information
        - https://dapi.kakao.com/v2/local/geo/coord2regioncode
    3. Google Map
    4. Sotify
        - https://api.spotify.com/v1/search

<br>

## 시연 시나리오
1. 메인 페이지
    - 메인 페이지 쓰롱된 음악 마커 확인 
2. 줍기
    - 메인 페이지에서 쓰롱된 노래를 클릭 후 스크롤 하며 하나의 곡 선택
    - 코멘트와 사진 확인 후 줍기 클릭
    - 플레이리스트에서 해당 노래를 유튜브 뮤직을 통해 바로 듣기
3. 쓰롱 
    - 하단바 가운데 버튼인 음악 검색을 통해 쓰롱 코멘트와 사진 첨부
    - 쓰롱하기 클릭
4. 쿠폰 사용 
    - 메인 페이지에서 반경 밖 음원 클릭
    - 쿠폰을 적용하여 음악 조회
5. 퀴즈 및 쿠폰 발급 
    - 컨텐츠 페이지에서 컨텐츠 소개 후 퀴즈 클릭
    - 퀴즈 3문제를 맞춘 뒤, 쿠폰 발급
6. 갤럭시 워치 사용 
    - 메인 페이지에서 물음표 마크 음원 클릭
    - 갤럭시 워치 화면 공유
    - 워치에서 내 주변 인기 음악 리스트 확인
    - 워치에서 내 플레이리스트 곡 중 하나를 선택
    - 음성인식을 통하여 쓰롱
